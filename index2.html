<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Visualizador Piura — NASA GIBS + Mapa de Calor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html,body { height:100%; margin:0; padding:0; font-family: Arial, sans-serif; }
  #topbar { background:#111; color:#fff; padding:8px 12px; display:flex; align-items:center; gap:12px; }
  #topbar h1 { margin:0; font-size:18px; }
  #controls { margin-left:auto; display:flex; gap:8px; align-items:center; }
  #map { width:100%; height:calc(100% - 48px); } 
  .btn { background:#2b7; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; }
  .btn.secondary { background:#48f; color:#fff; }
  label { color:#fff; font-size:13px; margin-right:6px; }
  input[type="date"] { padding:4px; border-radius:4px; border:1px solid #ccc; }
  .infoPane, .fenomenoPane {
    position:absolute;
    top:60px;
    left:12px;
    z-index:1000;
    background:rgba(255,255,255,0.95);
    padding:8px;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    max-width:320px;
    font-size:13px;
  }
  .legendPane {
    position:absolute;
    top:200px;
    left:12px;
    z-index:1000;
    background:rgba(255,255,255,0.95);
    padding:8px;
    border-radius:6px;
    box-shadow:0 2px 6px rgba(0,0,0,0.3);
    max-width:150px;
    font-size:13px;
  }
  .legendPane div { margin-top:4px; display:flex; align-items:center; gap:6px; }
  .legendPane .color-box { width:18px; height:18px; border:1px solid #000; }
  #fenomenoPane { display:none; max-width:350px; }
</style>
</head>
<body>
<div id="topbar">
  <h1>Visualizador Piura — NASA GIBS + Mapa de Calor</h1>
  <div id="controls">
    <label for="date">Fecha:</label>
    <input id="date" type="date" />
    <button id="goDate" class="btn secondary">Aplicar fecha</button>
    <button id="fitPeru" class="btn">Ir a Perú</button>
    <button id="fitPiura" class="btn">Ir a Piura</button>
    <button id="fenomenoBtn" class="btn secondary">Fenómeno Niño 2019</button>
  </div>
</div>

<div id="map"></div>

<div id="info" class="infoPane" style="display:block;">
  <strong>Coordenadas seleccionadas</strong>
  <div id="coords">Haz clic en el mapa</div>
  <hr style="margin:6px 0;">
  <div id="layerInfo">Capa: MODIS True Color</div>
</div>

<div id="fenomenoPane" class="fenomenoPane">
  <strong>Fenómeno El Niño 2019</strong>
  <div id="fenomenoInfo">
    <p>El Fenómeno del Niño 2019 afectó principalmente Piura con lluvias intensas e inundaciones.</p>
    <ul>
      <li>Inicio: Enero 2019</li>
      <li>Máxima precipitación: Marzo 2019</li>
      <li>Áreas afectadas: Costa norte de Perú, Piura y Tumbes</li>
    </ul>
    <p>Se generaron inundaciones graves en zonas urbanas y rurales.</p>
  </div>
</div>

<div class="legendPane">
  <strong>Intensidad de lluvia / Inundación</strong>
  <div><span class="color-box" style="background:green;"></span>Ligera</div>
  <div><span class="color-box" style="background:yellow;"></span>Moderada</div>
  <div><span class="color-box" style="background:red;"></span>Intensa</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
const peruBounds = [[-18.5, -81.5], [1.0, -68.0]];
const piuraBounds = [[-5.3, -80.75], [-5.1, -80.55]];
const today = new Date().toISOString().split('T')[0];
document.addEventListener('DOMContentLoaded', () => { document.getElementById('date').value = today; });

const map = L.map('map', { zoomSnap: 0.5 }).setView([-9.2, -75], 5);

function modisTemplate(time) {
  return `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${time}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`;
}
function imergTemplate(time) {
  return `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/IMERG_Precipitation_Rate_30min/default/${time}/GoogleMapsCompatible_Level6/{z}/{y}/{x}.png`;
}

const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles © Esri' });

let currentDate = today;
let modisLayer = L.tileLayer(modisTemplate(currentDate), { tileSize:256, minZoom:2, maxZoom:9, noWrap:true, attribution:"NASA EOSDIS GIBS — MODIS Terra True Color" });
let imergLayer = L.tileLayer(imergTemplate(currentDate), { tileSize:256, minZoom:2, maxZoom:6, opacity:0.65, noWrap:true, attribution:"NASA EOSDIS GIBS — IMERG Precipitation Rate (30min)" });
let streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors', opacity:0.8 });

modisLayer.addTo(map);
imergLayer.addTo(map);

// === Generador de puntos aleatorios de calor en todo el mundo
function generarDatosAleatorios(cantidad=200) {
  const puntos = [];
  for (let i = 0; i < cantidad; i++) {
    const lat = (Math.random() * 180) - 90;
    const lon = (Math.random() * 360) - 180;
    const intensidad = Math.random();
    puntos.push([lat, lon, intensidad]);
  }
  return puntos;
}

// === Mapas de calor iniciales
let heatPiura = L.heatLayer(generarDatosAleatorios(), {
  radius:35, blur:10, maxZoom:15, opacity:0.8,
  gradient:{0.0:'blue',0.5:'yellow',1.0:'red'}
}).addTo(map);

let heatPeru = L.heatLayer(generarDatosAleatorios(), {
  radius:45, blur:15, maxZoom:10, opacity:0.8,
  gradient:{0.0:'blue',0.5:'yellow',1.0:'red'}
}).addTo(map);

// === Predicción futura simulada
function generarPrediccionesFuturas(cantidad=100) {
  const puntos = [];
  for (let i = 0; i < cantidad; i++) {
    const lat = -5 + Math.random()*0.3;   // Piura aproximado
    const lon = -80.75 + Math.random()*0.2;
    const intensidad = Math.random();
    puntos.push([lat, lon, intensidad]);
  }
  return puntos;
}
let heatFuturo = L.heatLayer(generarPrediccionesFuturas(), {
  radius:35, blur:10, maxZoom:15, opacity:0.7,
  gradient:{0.0:'blue',0.5:'yellow',1.0:'red'}
});

// === Control de capas
const baseLayers = { 
  "MODIS True Color (NASA)": modisLayer, 
  "Esri World Imagery": esri 
};
const overlays = { 
  "Lluvia IMERG (NASA)": imergLayer, 
  "Calles OSM (zoom > 10)": streetLayer, 
  "Mapa de calor Piura": heatPiura,
  "Mapa de calor Perú": heatPeru,
  "Predicción futura inundaciones": heatFuturo
};
L.control.layers(baseLayers, overlays, { collapsed:false }).addTo(map);

function updateStreets() {
  if (map.getZoom() > 10) { if (!map.hasLayer(streetLayer)) streetLayer.addTo(map); }
  else { if (map.hasLayer(streetLayer)) map.removeLayer(streetLayer); }
}
map.on('zoomend', updateStreets);

document.getElementById('fitPeru').addEventListener('click', () => { map.fitBounds(peruBounds, { padding:[20,20] }); });

document.getElementById('fitPiura').addEventListener('click', () => { 
  map.fitBounds(piuraBounds, { padding:[20,20] }); 
  map.setZoom(13); 
  if (!map.hasLayer(imergLayer)) imergLayer.addTo(map);
  if (!map.hasLayer(heatPiura)) heatPiura.addTo(map);
  updateStreets();
});

// === APLICAR FECHA
document.getElementById('goDate').addEventListener('click', () => {
  const d = document.getElementById('date').value;
  if (!d) { alert('Elige una fecha.'); return; }
  currentDate = d;

  map.removeLayer(modisLayer);
  map.removeLayer(imergLayer);
  modisLayer = L.tileLayer(modisTemplate(currentDate), { tileSize:256, minZoom:2, maxZoom:9, noWrap:true, attribution:"NASA EOSDIS GIBS — MODIS Terra True Color" });
  imergLayer = L.tileLayer(imergTemplate(currentDate), { tileSize:256, minZoom:2, maxZoom:6, opacity:0.65, noWrap:true, attribution:"NASA EOSDIS GIBS — IMERG Precipitation Rate (30min)" });
  modisLayer.addTo(map);
  imergLayer.addTo(map);

  heatPiura.setLatLngs(generarDatosAleatorios()).addTo(map);
  heatPeru.setLatLngs(generarDatosAleatorios()).addTo(map);
  heatFuturo.setLatLngs(generarPrediccionesFuturas()).addTo(map);

  document.getElementById('layerInfo').innerText = `Capa: MODIS True Color — Fecha: ${currentDate}`;
  updateStreets();
});

let marker = null;
map.on('click', function(e) {
  const lat = Number(e.latlng.lat).toFixed(6);
  const lon = Number(e.latlng.lng).toFixed(6);
  document.getElementById('coords').innerHTML = `Lat: <strong>${lat}</strong>, Lon: <strong>${lon}</strong>`;
  if (marker) map.removeLayer(marker);
  marker = L.marker([lat, lon]).addTo(map);
});

map.fitBounds(peruBounds, { padding:[20,20] });
L.control.scale().addTo(map);

// === PESTAÑA FENÓMENO DEL NIÑO 2019
document.getElementById('fenomenoBtn').addEventListener('click', () => {
  const pane = document.getElementById('fenomenoPane');
  pane.style.display = pane.style.display === 'block' ? 'none' : 'block';
});
</script>
</body>
</html>